{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <style>
    .dashboard-page{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .dashboard-hero{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      align-items:center;
      justify-content:space-between;
      padding:18px 20px;
      background:linear-gradient(145deg, rgba(102,217,168,.08), rgba(78,124,255,.07)), var(--card);
      border:1px solid #1e2b3f;
    }
    .dashboard-hero .hero-text{
      flex:1;
      min-width:260px;
    }
    .dashboard-hero h2{
      margin:0 0 4px;
    }
    .hero-text p{
      margin:0;
      color:var(--muted);
    }
    .stat-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .stat-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:.35rem .75rem;
      border-radius:999px;
      border:1px solid #233354;
      background:#172033;
      color:#c3d3ff;
      font-weight:600;
      font-size:.9rem;
    }
    .stat-chip--assigned{
      border-color:#2f354d;
      background:#151b2b;
      color:#dfe2ff;
    }
    .stat-chip--discovered{
      border-color:#5a441f;
      background:#2f2415;
      color:#ffdca8;
    }
    .stat-chip--resolved{
      border-color:#1f5037;
      background:#12231b;
      color:#bdf0d2;
    }
    .wallet-panel{
      min-width:260px;
      border-radius:16px;
      padding:18px 20px;
      background:linear-gradient(135deg, rgba(51,209,122,.18), rgba(78,124,255,.28));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .wallet-label{
      font-size:.9rem;
      color:rgba(255,255,255,.8);
    }
    .wallet-amount{
      display:flex;
      align-items:baseline;
      gap:8px;
      font-size:2rem;
      font-weight:800;
      letter-spacing:.3px;
    }
    .wallet-amount .currency{
      font-size:.8em;
      opacity:.85;
    }
    .wallet-sub{
      margin-top:6px;
      font-size:.95rem;
      color:#e5f6ff;
    }
    .wallet-note{
      margin-top:10px;
      font-size:.9rem;
      color:rgba(255,255,255,.82);
    }
    .dashboard-clusters{
      display:flex;
      flex-direction:column;
      gap:16px;
      margin-top:8px;
    }
    .cluster{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .cluster-main,
    .cluster-actions,
    .cluster-infra{
      flex:1 1 auto;
    }
    .cluster-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .cluster-row--actions-news > .card{
      flex:1 1 calc(50% - 8px);
      min-width:220px;
    }
    .cluster-row--infra{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
    }
    .ports-card{
      display:flex;
      flex-direction:column;
    }
    .ports-card h3{
      margin:0;
    }
    .ports-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .ports-head p{
      margin:4px 0 0;
    }
    .ports-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .port-filter-group{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .ports-search input{
      width:180px;
    }
    .ports-table-wrap{
      margin-top:12px;
      overflow:auto;
      max-height:min(520px, 65vh);
      border:1px solid rgba(255,255,255,.07);
      border-radius:14px;
      background:rgba(5,8,13,.85);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.015);
      scrollbar-width:thin;
    }
    .ports-table-wrap::-webkit-scrollbar{
      width:8px;
      height:8px;
    }
    .ports-table-wrap::-webkit-scrollbar-thumb{
      border-radius:999px;
      background:rgba(99,141,255,.45);
    }
    #ports-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:640px;
    }
    #ports-table thead th{
      background:rgba(8,11,18,.95);
      border-bottom:1px solid rgba(255,255,255,.05);
      position:sticky;
      top:0;
      z-index:2;
      box-shadow:0 2px 12px rgba(0,0,0,.35);
      padding:10px 12px;
      font-size:.95rem;
    }
    #ports-table tbody tr{
      background:transparent;
      border-bottom:1px solid rgba(255,255,255,.04);
      transition:background .15s ease;
    }
    #ports-table tbody tr:hover{
      background:rgba(78,124,255,.08);
    }
    #ports-table tbody tr:last-child{
      border-bottom:none;
    }
    #ports-table tbody tr td{
      border-top:none;
      border-bottom:none;
      padding:8px 12px;
      font-size:.95rem;
    }
    .td-port strong{
      font-size:1rem;
      letter-spacing:.3px;
    }
    .status-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:.2rem .6rem;
      font-size:.85rem;
      font-weight:600;
    }
    .status-chip span{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
    }
    .status-chip--discovered{
      border:1px solid #5a441f;
      background:#2f2415;
      color:#ffdca8;
    }
    .status-chip--discovered span{background:#f5c84c;}
    .status-chip--resolved{
      border:1px solid #254a35;
      background:#1a2a20;
      color:#c9f2d4;
    }
    .status-chip--resolved span{background:#33d17a;}
    .status-chip--archived{
      border:1px solid #5b3e33;
      background:#2a2320;
      color:#f4d6c5;
    }
    .status-chip--archived span{background:#f7a77a;}
    .row-actions{
      display:flex;
      flex-wrap:nowrap;
      gap:6px;
      align-items:center;
    }
    .btn.micro{
      padding:4px 8px;
      font-size:.82rem;
      border-radius:8px;
      line-height:1.2;
    }
    .row-actions .btn{
      white-space:nowrap;
    }
    .mini-progress{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.85rem;
      color:var(--muted);
    }
    .mini-progress .mini-bar{
      width:120px;
      height:6px;
      border-radius:999px;
      background:#2a2a2a;
      overflow:hidden;
    }
    .mini-progress .mini-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#4e7cff,#6fffc3);
      transition:width .2s ease;
    }
    .action-card h3{
      margin-top:0;
    }
    .action-block + .action-block{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.05);
    }
    .action-block label{
      display:block;
      font-weight:700;
      margin-bottom:6px;
    }
    .news-card h3{
      margin:0 0 4px;
    }
    .news-module{
      margin-top:10px;
      padding:16px;
      border:1px dashed rgba(102,217,168,.35);
      border-radius:14px;
      background:rgba(15,22,32,.8);
    }
    .news-module .btn{
      width:100%;
      margin-top:12px;
    }
    .news-status-pill{
      padding:.3rem .7rem;
      border-radius:999px;
      border:1px solid #233354;
      font-size:.85rem;
      background:#172033;
      color:#c3d3ff;
      transition:background .2s ease, color .2s ease, border-color .2s ease;
    }
    .news-status-pill[data-state="running"]{
      background:#1a2a20;
      color:#c9f2d4;
      border-color:#254a35;
    }
    .news-status-pill[data-state="done"]{
      background:#262022;
      color:#ffd9c7;
      border-color:#5b3e33;
    }
    .news-progress-shell{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#11151f;
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      margin-top:10px;
    }
    .news-progress-fill{
      width:0%;
      height:100%;
      background:linear-gradient(90deg,#4e7cff,#59d7ff,#6fffc3,#f5c84c);
      background-size:250% 100%;
      animation:newsShimmer 3s linear infinite;
      transition:width .4s ease;
    }
    .news-result{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#12151e;
    }
    .news-result-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .news-result-head .btn{
      flex-shrink:0;
    }
    .news-hit-meta{
      margin-top:6px;
      font-size:.9rem;
      color:#9aa3ad;
    }
    .device-intel-card{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(100,195,255,.18);
      background:linear-gradient(140deg, rgba(59,120,255,.08), rgba(0,230,173,.05)), var(--card);
    }
    .device-intel-card::after{
      content:"";
      position:absolute;
      inset:auto -40% -40% auto;
      width:220px;
      height:220px;
      background:radial-gradient(circle, rgba(111,255,195,.25), transparent 70%);
      opacity:.6;
      pointer-events:none;
    }
    .device-intel-header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .device-intel-header h3{
      margin:0 0 4px;
    }
    .device-intel-pill{
      align-self:flex-start;
      padding:.35rem .9rem;
      border-radius:999px;
      border:1px solid rgba(111,255,195,.3);
      background:rgba(10,23,25,.7);
      font-size:.85rem;
      font-weight:600;
      color:#9cffe1;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .device-intel-grid{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:12px;
      position:relative;
      z-index:1;
    }
    .device-intel-item{
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,15,24,.75);
    }
    .device-intel-item span{
      display:block;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:6px;
    }
    .device-intel-item strong{
      display:block;
      font-size:1.1rem;
      font-weight:700;
      color:#eef9ff;
      word-break:break-word;
    }
    .device-intel-item .small{
      display:block;
      margin-top:4px;
    }
    .device-intel-footnote{
      margin-top:10px;
      position:relative;
      z-index:1;
    }
    .withdraw-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-bottom:10px;
      background:#0f141e;
      border:1px solid rgba(255,255,255,.05);
      border-radius:12px;
      padding:10px 12px;
    }
    .withdraw-summary div{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .withdraw-summary span{
      font-size:.85rem;
      color:var(--muted);
    }
    .withdraw-summary strong{
      font-size:1.1rem;
      font-weight:800;
      color:var(--text);
    }
    .withdraw-history{
      list-style:none;
      margin:10px 0 0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .withdraw-history li{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.05);
      border-radius:12px;
      background:#0f131c;
    }
    .withdraw-history__amount{
      font-size:1.05rem;
      font-weight:700;
    }
    .withdraw-history__date{
      font-size:.85rem;
      color:var(--muted);
    }
    .withdraw-history__empty{
      justify-content:center;
      color:var(--muted);
    }
    .withdraw-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:.25rem .65rem;
      font-size:.85rem;
      border:1px solid #233354;
      background:#172033;
      color:#c3d3ff;
    }
    .withdraw-status--success{
      border-color:#1f5037;
      background:#12231b;
      color:#bdf0d2;
    }
    .withdraw-status--danger{
      border-color:#6b252e;
      background:#2a1518;
      color:#ffcdd4;
    }
    .withdraw-status--neutral{
      border-color:#2e3a57;
      background:#151b2b;
      color:#d3d9f3;
    }
    .health-stats{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .health-stat{
      flex:1;
      min-width:120px;
    }
    #user-health-canvas{
      width:100%;
      margin-top:10px;
      border-radius:10px;
      background:#0f141e;
      border:1px solid rgba(255,255,255,.05);
    }
    @keyframes newsShimmer{
      0%{background-position:0% 0;}
      100%{background-position:200% 0;}
    }
    @media (min-width:961px){
      .dashboard-clusters{
        display:grid;
        grid-template-columns:minmax(0, 1fr) minmax(260px, 340px);
        gap:16px;
        align-items:flex-start;
      }
      .cluster-main{
        grid-column:1;
      }
      .cluster-actions,
      .cluster-infra{
        grid-column:2;
      }
      .cluster-actions{
        position:sticky;
        top:12px;
      }
    }
    @media (min-width:720px){
      .cluster-row--actions-news{
        flex-wrap:nowrap;
      }
    }
    @media (max-width:960px){
      .cluster-row--actions-news{
        flex-direction:column;
      }
      .cluster-row--infra{
        grid-template-columns:1fr;
      }
    }
    @media (max-width:640px){
      .dashboard-hero{
        padding:12px;
      }
      .dashboard-hero h2{
        font-size:1.2rem;
      }
      .hero-text p,
      .wallet-note,
      .wallet-sub{
        font-size:.85rem;
      }
      .ports-toolbar{
        flex-direction:column;
        align-items:stretch;
      }
      .ports-search input{
        width:100%;
      }
      .wallet-panel{
        width:100%;
      }
      .ports-table-wrap{
        max-height:min(420px, 60vh);
      }
      #ports-table{
        min-width:520px;
      }
      .row-actions{
        flex-wrap:wrap;
      }
      .cluster-row--actions-news{
        flex-direction:row;
        flex-wrap:wrap;
      }
      .cluster-row--actions-news > .card{
        flex:1 1 calc(50% - 6px);
        min-width:200px;
      }
      .action-card label,
      .news-card p,
      .news-module{
        font-size:.88rem;
      }
      .news-module .btn,
      .action-card .btn{
        font-size:.9rem;
      }
    }
    @media (max-width:480px){
      .dashboard-hero{
        padding:14px;
      }
      .wallet-amount{
        font-size:1.4rem;
      }
      .stat-row{
        flex-direction:column;
      }
      .stat-row .stat-chip{
        width:100%;
        justify-content:space-between;
      }
      .action-card,
      .news-card,
      .health-card,
      .device-intel-card{
        font-size:.9rem;
      }
      .row-actions{
        flex-direction:column;
        align-items:stretch;
      }
      .row-actions .btn,
      .row-actions form{
        width:100%;
      }
      .cluster-actions .btn,
      .cluster-infra .btn{
        width:100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
{% set clean_counts = namespace(discovered=0, resolved=0, archived=0) %}
{% for p in discovered %}
  {% if not (p.id and p.id[:7] == 'ledger-') %}
    {% set clean_counts.discovered = clean_counts.discovered + 1 %}
  {% endif %}
{% endfor %}
{% for p in resolved %}
  {% if not (p.id and p.id[:7] == 'ledger-') %}
    {% set clean_counts.resolved = clean_counts.resolved + 1 %}
  {% endif %}
{% endfor %}
{% for p in archived %}
  {% if not (p.id and p.id[:7] == 'ledger-') %}
    {% set clean_counts.archived = clean_counts.archived + 1 %}
  {% endif %}
{% endfor %}
<div class="dashboard-page rtl">
  <section class="card dashboard-hero">
    <div class="hero-text">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <p>ØªØ§Ø¨Ø¹ Ù…Ù†Ø§ÙØ°Ùƒ Ø§Ù„Ù…ÙƒØªØ´ÙØ© ({{ clean_counts.discovered }}) ÙˆØ§Ù„Ù…Ø­Ù„ÙˆÙ„Ø© ({{ clean_counts.resolved }})ØŒ Ø«Ù… Ø§Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙÙˆØ± Ø¬Ù‡ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯.</p>
      <div class="stat-row">
        <span class="stat-chip stat-chip--assigned">ğŸ“¦ Ø§Ù„Ù…Ø³Ù†Ø¯Ø©: <strong>{{ undiscovered_count }}</strong></span>
        <span class="stat-chip stat-chip--discovered">ğŸŸ¡ Ø§Ù„Ù…ÙƒØªØ´ÙØ©: <strong>{{ clean_counts.discovered }}</strong></span>
        <span class="stat-chip stat-chip--resolved">âœ… Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©: <strong>{{ clean_counts.resolved }}</strong></span>
      </div>
    </div>
    <div class="wallet-panel">
      <div class="wallet-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
      <div class="wallet-amount">
        <span id="available-balance"
              data-balance="{{ '%.2f'|format(available_balance or 0) }}">
          {{ '%.2f'|format(available_balance or 0) }}
        </span>
        <span class="currency">Ø±.Ø³</span>
      </div>
      <div class="wallet-sub">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: <strong>{{ '%.2f'|format(total_earned or 0) }}</strong> Ø±.Ø³
      </div>
      <div class="wallet-note">ğŸ”’ Ø£Ù…ÙˆØ§Ù„Ùƒ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø£Ù…Ø§Ù† Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.</div>
    </div>
  </section>

  <div class="dashboard-clusters">
    <section class="cluster cluster-actions">
      <div class="cluster-row cluster-row--actions-news">
        <div class="card action-card">
          <h3>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>

          <div class="action-block">
            <label>ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ°</label>
            <form id="scan-form">
              <button id="scan-btn" class="btn" type="button">
                ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ°
              </button>
            </form>
          </div>

          <div class="action-block">
            {% set withdraw_info = withdrawals or {} %}
            <label>Ø·Ù„Ø¨ Ø³Ø­Ø¨</label>
            <div class="withdraw-summary" data-withdraw-summary>
              <div>
                <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</span>
                <strong>{{ '%.2f'|format(available_balance or 0) }} Ø±.Ø³</strong>
              </div>
              <div>
                <span>Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                <strong data-withdraw-pending-count>{{ withdraw_info.pending_count or 0 }}</strong>
              </div>
              <div>
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚</span>
                <strong data-withdraw-pending-total>{{ '%.2f'|format(withdraw_info.pending_total or 0) }}</strong> <small>Ø±.Ø³</small>
              </div>
            </div>
            <form method="post" action="{{ url_for('user_withdraw_request') }}" style="display:flex;gap:8px;align-items:center;margin-top:8px;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="number" name="amount_sar" step="0.01" min="0" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø±.Ø³)" class="input" style="flex:1;min-width:120px;" required>
              <button class="btn secondary" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
            <ul class="withdraw-history" data-withdraw-history>
              {% if withdraw_info.recent %}
                {% for req in withdraw_info.recent %}
                  <li>
                    <div>
                      <div class="withdraw-history__amount">{{ '%.2f'|format(req.amount or 0) }} <span>Ø±.Ø³</span></div>
                      <div class="withdraw-history__date">{{ req.created_display or 'â€”' }}</div>
                    </div>
                    <span class="withdraw-status withdraw-status--{{ req.status_class or 'neutral' }}">{{ req.status_label }}</span>
                  </li>
                {% endfor %}
              {% else %}
                <li class="withdraw-history__empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.</li>
              {% endif %}
            </ul>
          </div>

          <div class="action-block">
            <label>ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</label>
            <form method="post" action="{{ url_for('user_clear_resolved') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn danger small" type="submit"
                      onclick="return confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ø±Ø¨Ø§Ø­. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                ğŸ§½ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©
              </button>
            </form>
          </div>
        </div>
        <div class="card news-card">
          <h3>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¶Ø±Ø¨Ø§Øª (Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø¹ÙŠØ¯)</h3>
          <p class="small muted">ÙŠØ´ØºÙ‘Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù‚Ø¯Ø© Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©ØŒ Ø«Ù… ØªØ±Ø¨Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª VulnMap.</p>
          <div id="news-search-module" class="news-module">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
              <div style="font-weight:700;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</div>
              <span class="news-status-pill" data-role="news-status-pill" data-state="idle">Ù‡Ø§Ø¯Ø¦</span>
            </div>
            <button class="btn" type="button" data-role="news-button">
              ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
            </button>
            <div class="news-progress-shell" data-role="news-progress-wrap" hidden>
              <div class="news-progress-fill" data-role="news-progress-fill"></div>
            </div>
            <div class="small muted" style="margin-top:6px;" data-role="news-timer"></div>
            <div class="news-result" data-role="news-result" hidden>
              <div class="news-result-head">
                <div style="font-weight:700;" data-role="news-result-title"></div>
                <button class="btn tertiary micro" type="button" data-role="news-clear">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
              </div>
              <div data-role="news-result-body"></div>
              <div class="news-hit-meta" data-role="news-hit-meta"></div>
            </div>
            <div class="small muted" style="margin-top:8px;" data-role="news-preview">
              Ø³ÙŠØ¸Ù‡Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙˆØ± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ­Ù„ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª VulnMap.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="cluster cluster-main">
      <div class="card ports-card">
        <div class="ports-head">
          <div>
            <h3>Ø§Ù„Ù…Ù†Ø§ÙØ°</h3>
            <p class="small muted">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ø£Ùˆ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©.</p>
          </div>
          <div class="ports-toolbar">
            <div class="btn-group port-filter-group">
              <button type="button" class="btn tertiary small port-filter is-active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
              <button type="button" class="btn tertiary small port-filter" data-filter="discovered">Ø§Ù„Ù…ÙƒØªØ´ÙØ©</button>
              <button type="button" class="btn tertiary small port-filter" data-filter="resolved">Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</button>
              <button type="button" class="btn tertiary small port-filter" data-filter="archived">Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</button>
            </div>
            <div class="ports-search">
              <input id="port-search" type="text" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ÙØ°â€¦">
            </div>
          </div>
        </div>

        <div class="ports-table-wrap">
          <table class="table" id="ports-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ù†ÙØ°</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th style="min-width:220px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="ports-body">
              {% set any_rows = (discovered|length + resolved|length + archived|length) > 0 %}
              {% if not any_rows %}
                <tr><td colspan="5" class="small muted" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ° Ø¸Ø§Ù‡Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø¶ØºØ· Â«ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ°Â».</td></tr>
              {% else %}
                {# --- Discovered --- #}
                {% for p in discovered %}
                  {% if p.id and p.id[:7] == 'ledger-' %}
                    {# skip synthetic ledger entries #}
                  {% else %}
                    <tr data-row-id="{{ p.id }}" data-status="discovered">
                      <td class="td-port" data-label="Ø§Ù„Ù…Ù†ÙØ°"><strong>{{ p.port_number }}</strong></td>
                      <td data-label="Ø§Ù„ÙˆØµÙ">â€”</td>
                      <td class="td-reward" data-label="Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©">{{ '%.2f'|format(p.reward or 0) }}</td>
                      <td class="td-status" data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                        <span class="status-chip status-chip--discovered">
                          <span></span> Ù…ÙƒØªØ´Ù
                        </span>
                      </td>
                      <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">
                        <div class="row-actions">
                          <form class="resolve-form">
                            <input type="hidden" name="port_id" value="{{ p.id }}">
                            <button class="btn micro resolve-btn" type="button"
                                    data-port-id="{{ p.id }}"
                                    data-ready-at="{{ p.ready_at or '' }}"
                                    data-delay-sec="{{ p.resolve_delay_sec or 0 }}"
                                    data-disc="{{ p.discovered_at or '' }}">
                              Ø­Ù„
                            </button>
                          </form>
                          <form class="archive-form">
                            <input type="hidden" name="port_id" value="{{ p.id }}">
                            <button class="btn tertiary micro" type="button">Ø£Ø±Ø´ÙØ©</button>
                          </form>
                          <div class="mini-progress" hidden>
                            <div class="mini-bar">
                              <div class="mini-fill"></div>
                            </div>
                            <span class="mini-txt small muted">â³ â€¦</span>
                          </div>
                        </div>
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}

                {# --- Resolved --- #}
                {% for p in resolved %}
                  {% if p.id and p.id[:7] == 'ledger-' %}
                    {# skip synthetic ledger entries #}
                  {% else %}
                    <tr data-row-id="{{ p.id }}" data-status="resolved">
                      <td class="td-port" data-label="Ø§Ù„Ù…Ù†ÙØ°"><strong>{{ p.port_number }}</strong></td>
                      <td data-label="Ø§Ù„ÙˆØµÙ">â€”</td>
                      <td class="td-reward" data-label="Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©">{{ '%.2f'|format(p.reward or 0) }}</td>
                      <td class="td-status" data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                        <span class="status-chip status-chip--resolved">
                          <span></span> ØªÙ… Ø§Ù„Ø­Ù„
                        </span>
                      </td>
                      <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"><span class="small muted">â€”</span></td>
                    </tr>
                  {% endif %}
                {% endfor %}

                {# --- Archived --- #}
                {% for p in archived %}
                  {% if p.id and p.id[:7] == 'ledger-' %}
                    {# skip synthetic ledger entries #}
                  {% else %}
                    <tr data-row-id="{{ p.id }}" data-status="archived">
                      <td class="td-port" data-label="Ø§Ù„Ù…Ù†ÙØ°"><strong>{{ p.port_number }}</strong></td>
                      <td data-label="Ø§Ù„ÙˆØµÙ">â€”</td>
                      <td class="td-reward" data-label="Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©">{{ '%.2f'|format(p.reward or 0) }}</td>
                      <td class="td-status" data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                        <span class="status-chip status-chip--archived">
                          <span></span> Ù…Ø¤Ø±Ø´Ù
                        </span>
                      </td>
                      <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">
                        <form class="unarchive-form" method="post" action="{{ url_for('user_unarchive') }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="port_id" value="{{ p.id }}">
                          <button class="btn tertiary micro" type="button">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                          <noscript>
                            <button class="btn tertiary small" type="submit">Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Ø¨Ø¯ÙˆÙ† JS)</button>
                          </noscript>
                        </form>
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="cluster cluster-infra">
      <div class="cluster-row cluster-row--infra">
        <div class="card health-card" id="health-card">
          <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… (CPU / RAM)</h3>
          <div class="health-stats">
            <div class="health-stat">
              <div class="small muted">Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬</div>
              <div style="font-size:1.4em;font-weight:700;"><span data-health-cpu>--%</span></div>
            </div>
            <div class="health-stat">
              <div class="small muted">Ø§Ù„Ø°Ø§ÙƒØ±Ø©</div>
              <div style="font-size:1.4em;font-weight:700;"><span data-health-ram>--%</span></div>
            </div>
          </div>
          <canvas id="user-health-canvas" height="140"></canvas>
          <div class="small muted" style="margin-top:6px;">
            Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span data-health-updated>â€”</span>
            <span data-health-status class="chip" style="margin-inline-start:8px;display:none;">ÙˆØ¶Ø¹ Ù…Ø¨Ø³Ø·</span>
          </div>
        </div>
        <div class="card device-intel-card" data-device-intel>
          <div class="device-intel-header">
            <div>
              <h3>Ø¨ØµÙ…Ø© Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„ÙÙˆØ±ÙŠØ©</h3>
              <p class="small muted" data-device-intel-summary>Ù†Ø±Ø³Ù„ Ø¥Ø´Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© Ù„Ù†ÙÙ‡Ù… Ø³Ù„ÙˆÙƒ Ø¬Ù‡Ø§Ø²Ùƒ ÙˆÙ†Ø¶Ø¨Ø· ØªØ¬Ø±Ø¨Ø© VulnMap Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
            </div>
            <span class="device-intel-pill" data-device-intel-pill>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„...</span>
          </div>
          <div class="device-intel-grid" data-device-intel-list>
            <div class="device-intel-item">
              <span>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</span>
              <strong>â€”</strong>
            </div>
            <div class="device-intel-item">
              <span>Ø§Ù„Ù†Ø¸Ø§Ù…</span>
              <strong>â€”</strong>
            </div>
            <div class="device-intel-item">
              <span>Ø§Ù„Ù…ØªØµÙØ­</span>
              <strong>â€”</strong>
            </div>
            <div class="device-intel-item">
              <span>Ø§Ù„Ø¯Ù‚Ø© ÙˆØ§Ù„Ù„ØºØ©</span>
              <strong>â€”</strong>
            </div>
          </div>
          <div class="device-intel-footnote small muted" data-device-intel-hints>
            Ù†Ù†ØªØ¸Ø± Ø§Ù„Ù…ØªØµÙØ­ Ù„ÙŠÙƒØ´Ù Ù‚Ø¯Ø±Ø§ØªÙ‡...
          </div>
        </div>
      </div>
    </section>
  </div>



<!-- Scan overlay (consumed by scan_animation.js) -->
<div id="scan-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#111; color:#eee; padding:22px 26px; border-radius:14px; min-width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.45);">
    <div style="font-weight:600; margin-bottom:10px;">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµ...</div>
    <div id="scan-gauge" style="height:6px; background:#2a2a2a; border-radius:999px; overflow:hidden;">
      <div id="scan-bar" style="height:100%; width:0%; background:linear-gradient(90deg,#35c,#7ad); transition:width .15s linear;"></div>
    </div>
    <div id="scan-status" style="margin-top:10px; font-size:0.95em; color:#ccc;">ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§ÙƒØªØ´Ø§Ù...</div>
  </div>
</div>

<!-- Endpoint wiring for static JS files -->
<div id="app-endpoints"
     data-scan-json="{{ url_for('user_scan_json') }}"
     data-resolve-json="{{ url_for('user_resolve_json') }}"
     data-withdraw-json="{{ url_for('user_withdraw_json') }}"
     data-archive-json="{{ url_for('user_archive_json') }}"
     data-unarchive-json="{{ url_for('user_unarchive_json') }}"
     data-metrics-json="{{ url_for('user_metrics_json') }}"
     data-wallet-json="{{ url_for('wallet_snapshot_json') }}"
     data-news-start="{{ url_for('news_search_start') }}"
     data-news-status="{{ url_for('news_search_status') }}"
     data-news-clear="{{ url_for('news_search_clear') }}"
     data-device-intel="{{ url_for('user_device_intel') }}"
     data-login-event-id="{{ login_event_id or '' }}"
     data-news-bootstrap='{{ {"job": news_job, "hit": news_hit}|tojson }}'></div>
{% endblock %}

{% block scripts %}
  <!-- Load base first (defines window.VM helpers/state), then features that attach onto VM -->
  <script src="{{ url_for('static', filename='js/user_dashboard.js') }}"></script>
  <script src="{{ url_for('static', filename='js/resolve_ports.js') }}"></script>
  <script src="{{ url_for('static', filename='js/scan_animation.js') }}"></script>
  <script src="{{ url_for('static', filename='js/news_search.js') }}"></script>

  <!-- Inline micro-interactions (front-end only; no backend changes) -->
  <script>
    (function () {
      // Helper: identify/hide synthetic ledger rows
      function isLedgerRow(tr) {
        if (!tr) return false;
        const id = (tr.getAttribute('data-row-id') || '').trim();
        return id.startsWith('ledger-');
      }
      function hideLedgerRows(scope) {
        const root = scope || document;
        const rows = root.querySelectorAll('tbody#ports-body tr[data-row-id]');
        rows.forEach(tr => {
          if (isLedgerRow(tr)) {
            tr.style.display = 'none';
            tr.dataset.ledgerHidden = '1';
            tr.classList.add('is-ledger-row');
          }
        });
      }

      // 1) Animate wallet balance count-up on load (non-intrusive)
      const balEl = document.getElementById('available-balance');
      if (balEl && !balEl.dataset.animated) {
        const finalVal = parseFloat(balEl.dataset.balance || balEl.textContent || '0') || 0;
        const duration = 800; // ms
        const start = performance.now();
        const startVal = 0;
        const fmt = (n) => n.toFixed(2);
        function step(t) {
          const p = Math.min(1, (t - start) / duration);
          const eased = (p < 0.5) ? (2*p*p) : (1 - Math.pow(-2*p + 2, 2)/2); // easeInOutQuad
          const val = startVal + (finalVal - startVal) * eased;
          balEl.textContent = fmt(val);
          if (p < 1) requestAnimationFrame(step);
          else { balEl.textContent = fmt(finalVal); balEl.dataset.animated = "1"; }
        }
        requestAnimationFrame(step);
      }

      // 2) Ports quick filters (never show ledger rows)
      const filters = document.querySelectorAll('.port-filter');
      const tbody = document.getElementById('ports-body');
      function applyFilter(mode) {
        if (!tbody) return;
        Array.from(tbody.querySelectorAll('tr[data-row-id]')).forEach(tr => {
          // Always hide ledger rows regardless of filter
          if (isLedgerRow(tr)) { tr.style.display = 'none'; return; }
          const st = tr.getAttribute('data-status') || 'other';
          tr.style.display = (mode === 'all' || st === mode) ? '' : 'none';
        });
      }
      filters.forEach(btn => {
        btn.addEventListener('click', () => {
          filters.forEach(b => b.classList.remove('is-active'));
          btn.classList.add('is-active');
          applyFilter(btn.dataset.filter);
        });
      });

      // 3) Port search by number (client-side filter)
      const searchInput = document.getElementById('port-search');
      if (searchInput && tbody) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.trim();
          const rows = Array.from(tbody.querySelectorAll('tr[data-row-id]'));
          if (!q) { rows.forEach(r => r.style.opacity = ''); return; }
          rows.forEach(r => {
            const cell = r.querySelector('.td-port');
            const txt = (cell && cell.textContent || '').trim();
            r.style.opacity = txt.includes(q) ? '' : '0.35';
          });
        });
      }

      // 4) Initial hide + observe future changes from AJAX re-renders
      hideLedgerRows(document);
      if (tbody && 'MutationObserver' in window) {
        const obs = new MutationObserver((muts) => {
          // After any row additions/updates, hide ledger rows again
          hideLedgerRows(tbody);
          // Re-apply current filter state (so new rows respect it)
          const active = document.querySelector('.port-filter.is-active');
          const mode = active ? active.dataset.filter : 'all';
          applyFilter(mode);
        });
        obs.observe(tbody, { childList: true, subtree: true });
      }
    })();
  </script>
{% endblock %}
