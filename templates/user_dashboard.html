{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <style>
    .news-module{
      margin-top:18px;
      padding:14px 12px;
      border:1px dashed rgba(102,217,168,.35);
      border-radius:12px;
      background:rgba(102,217,168,.04);
    }
    .news-status-pill{
      padding:.25rem .65rem;
      border-radius:999px;
      border:1px solid #233354;
      font-size:.85rem;
      background:#172033;
      color:#c3d3ff;
      transition:background .2s ease, color .2s ease, border-color .2s ease;
    }
    .news-status-pill[data-state="running"]{
      background:#1a2a20;
      color:#c9f2d4;
      border-color:#254a35;
    }
    .news-status-pill[data-state="done"]{
      background:#262022;
      color:#ffd9c7;
      border-color:#5b3e33;
    }
    .news-progress-shell{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#11151f;
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      margin-top:10px;
    }
    .news-progress-fill{
      width:0%;
      height:100%;
      background:linear-gradient(90deg,#4e7cff,#59d7ff,#6fffc3,#f5c84c);
      background-size:250% 100%;
      animation:newsShimmer 3s linear infinite;
      transition:width .4s ease;
    }
    .news-result{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#12151e;
    }
    .news-hit-meta{
      margin-top:6px;
      font-size:.9rem;
      color:#9aa3ad;
    }
    @keyframes newsShimmer{
      0%{background-position:0% 0;}
      100%{background-position:200% 0;}
    }
  </style>
{% endblock %}

{% block content %}
<div class="card rtl" style="overflow:visible;">
  <!-- Box 1: Main header -->
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div>
      <h2 id="hdr-counts" style="margin-bottom:4px;">
        Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ÙƒØªØ´ÙØ©: {{ discovered_count }} | Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©: {{ resolved_count }}
      </h2>
      <p class="small" style="margin-top:0;">Ù‚Ù… Ø¨ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø«Ù… Ø­Ù„ Ø§Ù„Ù…ÙƒØªØ´Ù Ù…Ù†Ù‡Ø§ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª.</p>
    </div>

    <!-- Mini stats chips -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <span class="chip" style="padding:.35rem .6rem;border-radius:999px;background:#172033;color:#b7cdfa;border:1px solid #233354;">
        ğŸŸ¡ Ù…ÙƒØªØ´ÙØ©: <strong style="margin-inline-start:6px;">{{ discovered_count }}</strong>
      </span>
      <span class="chip" style="padding:.35rem .6rem;border-radius:999px;background:#1a2a20;color:#c9f2d4;border:1px solid #254a35;">
        âœ… Ù…Ø­Ù„ÙˆÙ„Ø©: <strong style="margin-inline-start:6px;">{{ resolved_count }}</strong>
      </span>
    </div>
  </div>

  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;margin-top:12px;">

    <!-- Box 2: Ports (left, main) -->
    <div class="card" style="flex:2; min-width:560px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <h3 style="margin:0;">Ø§Ù„Ù…Ù†Ø§ÙØ°</h3>

        <!-- Ports toolbar: filters + search -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <div class="btn-group" style="display:flex;gap:6px;">
            <button type="button" class="btn tertiary small port-filter is-active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
            <button type="button" class="btn tertiary small port-filter" data-filter="discovered">Ø§Ù„Ù…ÙƒØªØ´ÙØ©</button>
            <button type="button" class="btn tertiary small port-filter" data-filter="resolved">Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</button>
            <button type="button" class="btn tertiary small port-filter" data-filter="archived">Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</button>
          </div>
          <div class="search" style="display:flex;align-items:center;gap:6px;">
            <input id="port-search" type="text" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ÙØ°â€¦" style="width:180px;">
          </div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <table class="table" id="ports-table" style="width:100%;border-collapse:separate;border-spacing:0 6px;">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ù†ÙØ°</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th>Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="min-width:260px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="ports-body">
            {% set any_rows = (discovered|length + resolved|length + archived|length) > 0 %}
            {% if not any_rows %}
              <tr><td colspan="5" style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ° Ø¸Ø§Ù‡Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø¶ØºØ· "ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ°".</td></tr>
            {% else %}
              {# --- Discovered --- #}
              {% for p in discovered %}
                {% if p.id and p.id[:7] == 'ledger-' %}
                  {# skip synthetic ledger entries #}
                {% else %}
                  <tr data-row-id="{{ p.id }}" data-status="discovered">
                    <td class="td-port"><strong>{{ p.port_number }}</strong></td>
                    <td>â€”</td>
                    <td class="td-reward">{{ '%.2f'|format(p.reward or 0) }}</td>
                    <td class="td-status">
                      <span style="padding:.2rem .5rem;border-radius:999px;background:#172033;color:#b7cdfa;border:1px solid #233354;display:inline-flex;align-items:center;gap:6px;">
                        <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f5c84c;"></span> Ù…ÙƒØªØ´Ù
                      </span>
                    </td>
                    <td>
                      <div class="row-actions" style="display:flex;gap:8px;align-items:center;">
                        <form class="resolve-form">
                          <input type="hidden" name="port_id" value="{{ p.id }}">
                          <button class="btn resolve-btn" type="button"
                                  data-port-id="{{ p.id }}"
                                  data-ready-at="{{ p.ready_at or '' }}"
                                  data-delay-sec="{{ p.resolve_delay_sec or 0 }}"
                                  data-disc="{{ p.discovered_at or '' }}">
                            Ø­Ù„
                          </button>
                        </form>
                        <form class="archive-form">
                          <input type="hidden" name="port_id" value="{{ p.id }}">
                          <button class="btn tertiary" type="button">Ø£Ø±Ø´ÙØ©</button>
                        </form>
                        <div class="mini-progress" hidden>
                          <div class="mini-bar" style="width:120px;height:6px;background:#2a2a2a;border-radius:999px;overflow:hidden;">
                            <div class="mini-fill" style="height:100%;width:0%"></div>
                          </div>
                          <span class="mini-txt small muted" style="margin-inline-start:6px;">â³ â€¦</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}

              {# --- Resolved --- #}
              {% for p in resolved %}
                {% if p.id and p.id[:7] == 'ledger-' %}
                  {# skip synthetic ledger entries #}
                {% else %}
                  <tr data-row-id="{{ p.id }}" data-status="resolved">
                    <td class="td-port"><strong>{{ p.port_number }}</strong></td>
                    <td>â€”</td>
                    <td class="td-reward">{{ '%.2f'|format(p.reward or 0) }}</td>
                    <td class="td-status">
                      <span style="padding:.2rem .5rem;border-radius:999px;background:#1a2a20;color:#c9f2d4;border:1px solid #254a35;display:inline-flex;align-items:center;gap:6px;">
                        <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#33d17a;"></span> ØªÙ… Ø§Ù„Ø­Ù„
                      </span>
                    </td>
                    <td><span class="small muted">â€”</span></td>
                  </tr>
                {% endif %}
              {% endfor %}

              {# --- Archived --- #}
              {% for p in archived %}
                {% if p.id and p.id[:7] == 'ledger-' %}
                  {# skip synthetic ledger entries #}
                {% else %}
                  <tr data-row-id="{{ p.id }}" data-status="archived">
                    <td class="td-port"><strong>{{ p.port_number }}</strong></td>
                    <td>â€”</td>
                    <td class="td-reward">{{ '%.2f'|format(p.reward or 0) }}</td>
                    <td class="td-status">
                      <span style="padding:.2rem .5rem;border-radius:999px;background:#2a2320;color:#f4d6c5;border:1px solid #5b3e33;display:inline-flex;align-items:center;gap:6px;">
                        <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f7a77a;"></span> Ù…Ø¤Ø±Ø´Ù
                      </span>
                    </td>
                    <td>
                      <form class="unarchive-form" method="post" action="{{ url_for('user_unarchive') }}" style="display:inline-flex;gap:6px;align-items:center;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="port_id" value="{{ p.id }}">
                        <button class="btn tertiary small" type="button">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                        <noscript>
                          <button class="btn tertiary small" type="submit">Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Ø¨Ø¯ÙˆÙ† JS)</button>
                        </noscript>
                      </form>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Sidebar (right) : Box 4 (Actions) above Box 3 (Wallet) -->
    <div style="flex:1; min-width:300px; display:flex; flex-direction:column; gap:12px; position:sticky; top:10px;">

      <!-- Box 4: Actions -->
      <div class="card">
        <h3 style="margin-top:0;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h3>

        <!-- Scan (handled by scan_animation.js) -->
        <form id="scan-form" style="margin-top:6px;">
          <button id="scan-btn" class="btn" type="button" style="width:100%;font-size:1.05em;padding:.8rem 1rem;">
            ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ°
          </button>
        </form>

        <!-- Withdraw (real HTML POST) -->
        <form method="post" action="{{ url_for('user_withdraw_request') }}" style="margin-top:10px;display:flex;gap:8px;align-items:center;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="number" name="amount_sar" step="0.01" min="0" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)" class="input" style="flex:1;min-width:120px;" required>
          <button class="btn secondary" type="submit">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
        </form>

        <p class="small muted" style="margin-top:8px;">
          ØªÙ„Ù…ÙŠØ­: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ø­Ø¨ ÙÙˆØ± ÙˆØµÙˆÙ„ Ø§Ù„Ø±ØµÙŠØ¯.
        </p>

        <div id="news-search-module" class="news-module">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:700;">Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¶Ø±Ø¨Ø§Øª (Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø¹ÙŠØ¯)</div>
              <div class="small muted" style="margin-top:2px;">ÙŠÙØ´ØºÙ‘Ù„ Ù†Ø¸Ø§Ù… ØªØ­ÙƒÙ… Ø°ÙƒÙŠ ÙŠØ¨Ø­Ø« Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… ÙŠØ¹Ø¨Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª VulnMap Ø¹Ù† Ø§Ù„Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨Ù„Ø©.</div>
            </div>
            <span class="news-status-pill" data-role="news-status-pill" data-state="idle">Ù‡Ø§Ø¯Ø¦</span>
          </div>
          <button class="btn" type="button" data-role="news-button" style="width:100%;margin-top:12px;">
            ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
          </button>
          <div class="news-progress-shell" data-role="news-progress-wrap" hidden>
            <div class="news-progress-fill" data-role="news-progress-fill" style="width:0%;"></div>
          </div>
          <div class="small muted" style="margin-top:6px;" data-role="news-timer"></div>
          <div class="news-result" data-role="news-result" hidden>
            <div style="font-weight:700;margin-bottom:4px;" data-role="news-result-title"></div>
            <div data-role="news-result-body"></div>
            <div class="news-hit-meta" data-role="news-hit-meta"></div>
          </div>
          <div class="small muted" style="margin-top:8px;" data-role="news-preview">
            Ø³ÙŠØ¸Ù‡Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙˆØ± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ­Ù„ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª VulnMap.
          </div>
        </div>
      </div>

      <!-- Box 3: Wallet (only Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ) -->
      <div class="card" style="overflow:hidden;">
        <h3 style="margin-top:0;">Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>

        <!-- Decorative gradient band -->
        <div aria-hidden="true" style="height:6px;border-radius:8px;background:linear-gradient(90deg,#4e7cff,#59d7ff,#6fffc3);opacity:.4;margin:-4px 0 8px;"></div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div>
            <div class="small muted" style="margin-bottom:2px;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div style="font-size:1.6em;font-weight:800;letter-spacing:.3px;">
              <span id="available-balance"
                    data-balance="{{ '%.2f'|format(available_balance or 0) }}">
                {{ '%.2f'|format(available_balance or 0) }}
              </span>
              <span class="small" style="opacity:.85;margin-inline-start:6px;">Ø±.Ø³</span>
            </div>
          </div>
          <!-- Lock icon hinting persistence across cleanup -->
          <div title="ÙŠØ³ØªÙ…Ø± Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ" style="opacity:.75;font-size:1.3em;">ğŸ”’</div>
        </div>

        <p class="small muted" style="margin-top:8px;">
          Ø£Ù…ÙˆØ§Ù„Ùƒ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø£Ù…Ø§Ù† ÙÙŠ Ù…ÙƒØ§Ù† Ø®Ø§Øµ Ùˆ Ø¢Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹.
        </p>
      </div>

    </div>

  </div>
</div>

<!-- Scan overlay (consumed by scan_animation.js) -->
<div id="scan-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#111; color:#eee; padding:22px 26px; border-radius:14px; min-width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.45);">
    <div style="font-weight:600; margin-bottom:10px;">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµ...</div>
    <div id="scan-gauge" style="height:6px; background:#2a2a2a; border-radius:999px; overflow:hidden;">
      <div id="scan-bar" style="height:100%; width:0%; background:linear-gradient(90deg,#35c,#7ad); transition:width .15s linear;"></div>
    </div>
    <div id="scan-status" style="margin-top:10px; font-size:0.95em; color:#ccc;">ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§ÙƒØªØ´Ø§Ù...</div>
  </div>
</div>

<!-- Endpoint wiring for static JS files -->
<div id="app-endpoints"
     data-scan-json="{{ url_for('user_scan_json') }}"
     data-resolve-json="{{ url_for('user_resolve_json') }}"
     data-withdraw-json="{{ url_for('user_withdraw_json') }}"
     data-archive-json="{{ url_for('user_archive_json') }}"
     data-unarchive-json="{{ url_for('user_unarchive_json') }}"
     data-news-start="{{ url_for('news_search_start') }}"
     data-news-status="{{ url_for('news_search_status') }}"
     data-news-bootstrap='{{ {"job": news_job, "hit": news_hit}|tojson }}'></div>
{% endblock %}

{% block scripts %}
  <!-- Load base first (defines window.VM helpers/state), then features that attach onto VM -->
  <script src="{{ url_for('static', filename='js/user_dashboard.js') }}"></script>
  <script src="{{ url_for('static', filename='js/resolve_ports.js') }}"></script>
  <script src="{{ url_for('static', filename='js/scan_animation.js') }}"></script>
  <script src="{{ url_for('static', filename='js/news_search.js') }}"></script>

  <!-- Inline micro-interactions (front-end only; no backend changes) -->
  <script>
    (function () {
      // Helper: identify/hide synthetic ledger rows
      function isLedgerRow(tr) {
        if (!tr) return false;
        const id = (tr.getAttribute('data-row-id') || '').trim();
        return id.startsWith('ledger-');
      }
      function hideLedgerRows(scope) {
        const root = scope || document;
        const rows = root.querySelectorAll('tbody#ports-body tr[data-row-id]');
        rows.forEach(tr => {
          if (isLedgerRow(tr)) {
            tr.style.display = 'none';
            tr.dataset.ledgerHidden = '1';
            tr.classList.add('is-ledger-row');
          }
        });
      }

      // 1) Animate wallet balance count-up on load (non-intrusive)
      const balEl = document.getElementById('available-balance');
      if (balEl && !balEl.dataset.animated) {
        const finalVal = parseFloat(balEl.dataset.balance || balEl.textContent || '0') || 0;
        const duration = 800; // ms
        const start = performance.now();
        const startVal = 0;
        const fmt = (n) => n.toFixed(2);
        function step(t) {
          const p = Math.min(1, (t - start) / duration);
          const eased = (p < 0.5) ? (2*p*p) : (1 - Math.pow(-2*p + 2, 2)/2); // easeInOutQuad
          const val = startVal + (finalVal - startVal) * eased;
          balEl.textContent = fmt(val);
          if (p < 1) requestAnimationFrame(step);
          else { balEl.textContent = fmt(finalVal); balEl.dataset.animated = "1"; }
        }
        requestAnimationFrame(step);
      }

      // 2) Ports quick filters (never show ledger rows)
      const filters = document.querySelectorAll('.port-filter');
      const tbody = document.getElementById('ports-body');
      function applyFilter(mode) {
        if (!tbody) return;
        Array.from(tbody.querySelectorAll('tr[data-row-id]')).forEach(tr => {
          // Always hide ledger rows regardless of filter
          if (isLedgerRow(tr)) { tr.style.display = 'none'; return; }
          const st = tr.getAttribute('data-status') || 'other';
          tr.style.display = (mode === 'all' || st === mode) ? '' : 'none';
        });
      }
      filters.forEach(btn => {
        btn.addEventListener('click', () => {
          filters.forEach(b => b.classList.remove('is-active'));
          btn.classList.add('is-active');
          applyFilter(btn.dataset.filter);
        });
      });

      // 3) Port search by number (client-side filter)
      const searchInput = document.getElementById('port-search');
      if (searchInput && tbody) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.trim();
          const rows = Array.from(tbody.querySelectorAll('tr[data-row-id]'));
          if (!q) { rows.forEach(r => r.style.opacity = ''); return; }
          rows.forEach(r => {
            const cell = r.querySelector('.td-port');
            const txt = (cell && cell.textContent || '').trim();
            r.style.opacity = txt.includes(q) ? '' : '0.35';
          });
        });
      }

      // 4) Initial hide + observe future changes from AJAX re-renders
      hideLedgerRows(document);
      if (tbody && 'MutationObserver' in window) {
        const obs = new MutationObserver((muts) => {
          // After any row additions/updates, hide ledger rows again
          hideLedgerRows(tbody);
          // Re-apply current filter state (so new rows respect it)
          const active = document.querySelector('.port-filter.is-active');
          const mode = active ? active.dataset.filter : 'all';
          applyFilter(mode);
        });
        obs.observe(tbody, { childList: true, subtree: true });
      }
    })();
  </script>
{% endblock %}
